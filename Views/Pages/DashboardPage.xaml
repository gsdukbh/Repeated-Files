<Page
    x:Class="Repeated_Files.Views.Pages.DashboardPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:Repeated_Files.Views.Pages"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:helpers="clr-namespace:Repeated_Files.Helpers"
    Title="DashboardPage"
    d:DataContext="{d:DesignInstance local:DashboardPage,
                                     IsDesignTimeCreatable=False}"
    d:DesignHeight="450"
    d:DesignWidth="800"
    ui:Design.Background="{DynamicResource ApplicationBackgroundBrush}"
    ui:Design.Foreground="{DynamicResource TextFillColorPrimaryBrush}"
    Foreground="{DynamicResource TextFillColorPrimaryBrush}"
    mc:Ignorable="d">

    <Page.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <helpers:InverseBooleanConverter x:Key="InverseBooleanConverter" />
        <helpers:DuplicateFileCountConverter x:Key="DuplicateFileCountConverter" />
    </Page.Resources>

    <!-- 使用 DockPanel 让分页栏固定底部 -->
    <DockPanel LastChildFill="True">
        <!-- 分页操作栏 固定底部 -->
        <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center" Margin="10">
            <ui:Button Margin="2" Command="{Binding ViewModel.FirstPageCommand}" IsEnabled="{Binding ViewModel.CanGoToPreviousPage}" ToolTip="第一页" >
                <ui:SymbolIcon Symbol="Home16" />
            </ui:Button>
            <ui:Button Margin="2" Command="{Binding ViewModel.PreviousPageCommand}" IsEnabled="{Binding ViewModel.CanGoToPreviousPage}" ToolTip="上一页" >
                <ui:SymbolIcon Symbol="ArrowLeft16" />
            </ui:Button>
            <ui:Button Margin="2" Command="{Binding ViewModel.NextPageCommand}" IsEnabled="{Binding ViewModel.CanGoToNextPage}" ToolTip="下一页" >
                <ui:SymbolIcon Symbol="ArrowRight16" />
            </ui:Button>
            <ui:Button Margin="2" Command="{Binding ViewModel.LastPageCommand}" IsEnabled="{Binding ViewModel.CanGoToNextPage}" ToolTip="最后一页" >
                <ui:SymbolIcon Symbol="ArrowStepInRight16" />
            </ui:Button>
            <TextBlock Margin="10,0" VerticalAlignment="Center" Text="{Binding ViewModel.PageInfo}" FontWeight="SemiBold" />
            <TextBlock Margin="5,0" VerticalAlignment="Center" Text="跳转到:" />
            <TextBox Margin="5,0" Text="{Binding ViewModel.JumpToPageNumber, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" VerticalContentAlignment="Center" HorizontalContentAlignment="Center" Width="60" />
            <ui:Button Margin="2" Content="跳转" Command="{Binding ViewModel.JumpToPageCommand}" />
            <TextBlock Margin="20,0,5,0" VerticalAlignment="Center" Text="每页显示:" />
            <ComboBox Margin="0,0,5,0"  SelectedItem="{Binding ViewModel.PageSize, Mode=TwoWay}" VerticalContentAlignment="Center">
                <ComboBoxItem Content="10" />
                <ComboBoxItem Content="20" />
                <ComboBoxItem Content="50" />
                <ComboBoxItem Content="100" />
            </ComboBox>
            <TextBlock Margin="0,0,5,0" VerticalAlignment="Center" Text="条" />
        </StackPanel>

        <!-- 顶部区域：按钮、进度、统计信息 -->
        <StackPanel DockPanel.Dock="Top" Orientation="Vertical" Margin="10">
            <!-- 按钮组 -->
            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                <ui:Button Margin="5" Command="{Binding ViewModel.SelectFolderCommand, Mode=OneWay}" Content="选择目录" Icon="Folder24" Appearance="Primary" />
                <ui:Button Margin="5" Command="{Binding ViewModel.ScanDiffFilesCommand, Mode=OneWay}" Content="开始扫描" Icon="Search24" IsEnabled="{Binding ViewModel.IsScanning, Converter={StaticResource InverseBooleanConverter}}" />
                <ui:Button Margin="5" Command="{Binding ViewModel.DeleteSelectedFilesCommand, Mode=OneWay}" Content="删除选中" Icon="Delete24" Appearance="Danger" />
                <ui:Button Margin="5" Command="{Binding ViewModel.ClearAllRecordsCommand, Mode=OneWay}" Content="清空记录" Icon="Clear24" />
            </StackPanel>
            <!-- 路径显示 -->
            <TextBlock Margin="5" VerticalAlignment="Center" Text="{Binding ViewModel.PathToScan, Mode=OneWay, StringFormat='扫描路径: {0}'}" FontWeight="SemiBold" />
            <!-- 进度信息 -->
            <TextBlock Margin="5" VerticalAlignment="Center" Text="{Binding ViewModel.ScanProgress, Mode=OneWay}" Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
            <!-- 进度条 -->
            <ProgressBar IsIndeterminate="{Binding ViewModel.IsScanning, Mode=OneWay}" Visibility="{Binding ViewModel.IsScanning, Converter={StaticResource BooleanToVisibilityConverter}}" Margin="0,0,0,10" />
            <!-- 统计信息 -->
            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                <TextBlock Text="{Binding ViewModel.FileGroups.Count, StringFormat='文件组数: {0}'}" Margin="0,0,20,0" />
                <TextBlock Text="{Binding ViewModel.FileRecords.Count, StringFormat='总文件数: {0}'}" Margin="0,0,20,0" />
                <TextBlock Text="{Binding ViewModel.FileRecords, Converter={StaticResource DuplicateFileCountConverter}, StringFormat='重复文件数: {0}'}" Margin="0,0,20,0" />
            </StackPanel>
        </StackPanel>

        <!-- 中间填充：文件分组列表 -->
        <ScrollViewer Margin="10" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
            <TreeView ItemsSource="{Binding ViewModel.FileGroups}" Background="Transparent" BorderThickness="0">
                <TreeView.ItemContainerStyle>
                    <Style TargetType="TreeViewItem">
                        <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}" />
                        <Setter Property="Padding" Value="5" />
                        <Setter Property="Margin" Value="0,2" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsDuplicateGroup}" Value="True">
                                <Setter Property="Foreground" Value="Red" />
                                <Setter Property="FontWeight" Value="Bold" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </TreeView.ItemContainerStyle>
                
                <!-- 文件组模板 -->
                <TreeView.ItemTemplate>
                    <HierarchicalDataTemplate ItemsSource="{Binding Files}">
                        <!-- 组头：文件名和数量 -->
                        <StackPanel Orientation="Horizontal" Margin="0,5">
                            <ui:SymbolIcon Symbol="Document16" Margin="0,0,5,0" VerticalAlignment="Center" />
                            <TextBlock Text="{Binding FileName}" FontWeight="SemiBold" FontSize="14" VerticalAlignment="Center" />
                            <TextBlock Text="{Binding FileCount, StringFormat=' ({0} 个文件)'}" 
                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}" 
                                       Margin="5,0" VerticalAlignment="Center" />
                            <Border Background="Orange" CornerRadius="3" Padding="3,1" Margin="5,0" 
                                    Visibility="{Binding IsDuplicateGroup, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <TextBlock Text="重复" Foreground="White"  FontWeight="Bold" />
                            </Border>
                        </StackPanel>
                        
                        <!-- 文件项模板 -->
                        <HierarchicalDataTemplate.ItemTemplate>
                            <DataTemplate>
                                <Border Padding="5" Margin="0,1" Background="{DynamicResource ControlFillColorDefaultBrush}" 
                                        CornerRadius="3" BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}" BorderThickness="1">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        
                                        <!-- 复选框 -->
                                        <CheckBox Grid.Column="0" IsChecked="{Binding IsChecked, Mode=TwoWay}" 
                                                  Margin="0,0,10,0" VerticalAlignment="Center" />
                                        
                                        <!-- 文件路径 -->
                                        <TextBlock Grid.Column="1" Text="{Binding FilePath}" 
                                                   VerticalAlignment="Center" TextTrimming="CharacterEllipsis"
                                                   ToolTip="{Binding FilePath}" />
                                        
                                        <!-- 文件大小 -->
                                        <TextBlock Grid.Column="2" Text="{Binding FileSizeFormatted}" 
                                                   Margin="10,0" VerticalAlignment="Center" 
                                                   Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                                        
                                        <!-- 修改时间 -->
                                        <TextBlock Grid.Column="3" Text="{Binding LastModified, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}" 
                                                   Margin="10,0" VerticalAlignment="Center" 
                                                   Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                                        
                                        <!-- 操作按钮 -->
                                        <ui:Button Grid.Column="4" Content="打开目录" Margin="10,0,0,0" 
                                                   VerticalAlignment="Center" Padding="5,2"
                                                   Command="{Binding DataContext.ViewModel.RightSelectCommand, RelativeSource={RelativeSource AncestorType=TreeView}}"
                                                   CommandParameter="{Binding FileRecord}"
                                                   ToolTip="在资源管理器中打开文件所在目录" />
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </HierarchicalDataTemplate.ItemTemplate>
                    </HierarchicalDataTemplate>
                </TreeView.ItemTemplate>
            </TreeView>
        </ScrollViewer>
    </DockPanel>
</Page>